import sys
import pytest as pytest
from ripper.health_check import classify_host_status, count_host_statuses, fetch_host_statuses
from ripper.constants import HOST_IN_PROGRESS_STATUS, HOST_FAILED_STATUS, HOST_SUCCESS_STATUS
from ripper.context import Context
from ripper.services import update_host_ip


@pytest.mark.parametrize('value, status', [
    (None, HOST_IN_PROGRESS_STATUS),
    ([{'error': 'Connection timed out'}], HOST_FAILED_STATUS),
    ([{'address': '4.2.2.2', 'time': 0.040173 }], HOST_SUCCESS_STATUS),
])
def test_classify_host_status(value, status):
    assert classify_host_status(value) == status


@pytest.mark.parametrize('distribution, statuses_counter', [
    ({"at1.node.check-host.net": [{"address": "95.173.136.72","time": 0.067267}], "ch1.node.check-host.net": [{"address": "95.173.136.72","time": 0.080538}], "de4.node.check-host.net": [{"address": "95.173.136.72","time": 1.078855}], "ir1.node.check-host.net": [{'error': 'Connection timed out'}], "it2.node.check-host.net": [{"address": "95.173.136.71","time": 0.063825}], "md1.node.check-host.net": [{"address": "95.173.136.70","time": 0.159452}], "nl1.node.check-host.net": [{'error': 'Connection timed out'}], "us1.node.check-host.net": None, "us2.node.check-host.net": [{"address": "95.173.136.70","time": 0.13008}]},
     {'HOST_IN_PROGRESS': 1, 'HOST_FAILED': 2, 'HOST_SUCCESS': 6}),
    ({'at1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.032494}], 'au1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.33341}], 'ca1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.107207}], 'ch1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.029638}], 'de4.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.01571}], 'fr2.node.check-host.net': [{'error': 'Bad file descriptor'}], 'hk1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.285371}], 'ir1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.131008}], 'it2.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.034573}], 'kz1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.102738}], 'lt1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.022713}], 'md1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.053072}], 'nl1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.021952}], 'pt1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.056825}], 'ru1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.025348}], 'ru2.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.031672}], 'tr1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.050391}], 'ua1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.0212}], 'ua2.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.014338}], 'us1.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.165094}], 'us2.node.check-host.net': [{'address': '172.217.20.206', 'time': 0.096323}]},
     {'HOST_SUCCESS': 20, 'HOST_FAILED': 1}),
    ({'at1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'au1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'ca1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'ch1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'de4.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'fr2.node.check-host.net': [{'address': '172.217.20.206', 'error': 'Exiting subroutine via redo at /usr/local/share/perl/5.24.1/AnyEvent/Handle/UDP.pm line 246.\n', 'time': 0.000176}], 'hk1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'ir1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'it2.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'kz1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'lt1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'md1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'nl1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'pt1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'ru1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'ru2.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'tr1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'ua1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'ua2.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'us1.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}], 'us2.node.check-host.net': [{'address': '172.217.20.206', 'timeout': 1}]},
     {'HOST_SUCCESS': 20, 'HOST_FAILED': 1}),
    ({'at1.node.check-host.net': [[0, 3.0003969669342, 'Connection timed out', None, None]], 'au1.node.check-host.net': [None, {'message': 'Connect timeout'}], 'ca1.node.check-host.net': [[0, 3.00023102760315, 'Connection timed out', None, None]], 'ch1.node.check-host.net': [[0, 3.00048208236694, 'Connection timed out', None, None]], 'de4.node.check-host.net': [[0, 2.99997591972351, 'Connection timed out', None, None]], 'fr2.node.check-host.net': [[0, 2.99960803985596, 'Connection timed out', None, None]], 'hk1.node.check-host.net': [[0, 2.99914598464966, 'Connection timed out', None, None]], 'ir1.node.check-host.net': [[0, 2.99958801269531, 'Connection timed out', None, None]], 'it2.node.check-host.net': [[0, 3.00138711929321, 'Connection timed out', None, None]], 'kz1.node.check-host.net': [[0, 3.00008606910706, 'Connection timed out', None, None]], 'lt1.node.check-host.net': [[0, 3.00026416778564, 'Connection timed out', None, None]], 'md1.node.check-host.net': [[0, 2.99959111213684, 'Connection timed out', None, None]], 'nl1.node.check-host.net': [[0, 3.00019598007202, 'Connection timed out', None, None]], 'pt1.node.check-host.net': [[0, 2.99966788291931, 'Connection timed out', None, None]], 'ru1.node.check-host.net': [[0, 3.00016188621521, 'Connection timed out', None, None]], 'ru2.node.check-host.net': [[0, 3.00004005432129, 'Connection timed out', None, None]], 'tr1.node.check-host.net': [[0, 2.99992299079895, 'Connection timed out', None, None]], 'ua1.node.check-host.net': [[0, 2.99965691566467, 'Connection timed out', None, None]], 'ua2.node.check-host.net': [[0, 3.00030899047852, 'Connection timed out', None, None]], 'us1.node.check-host.net': [[0, 2.9992949962616, 'Connection timed out', None, None]], 'us2.node.check-host.net': [[0, 3.00042986869812, 'Connection timed out', None, None]]},
     {'HOST_FAILED': 21}),
    ({'at1.node.check-host.net': [[1, 0.103471040725708, 'Moved Permanently', '301', '172.217.20.206']], 'au1.node.check-host.net': [[1, 0.706444025039673, 'Moved Permanently', '301', '172.217.20.206']], 'ca1.node.check-host.net': [[1, 0.251919984817505, 'Moved Permanently', '301', '172.217.20.206']], 'ch1.node.check-host.net': [[1, 0.0976769924163818, 'Moved Permanently', '301', '172.217.20.206']], 'de4.node.check-host.net': [[1, 0.0723910331726074, 'Moved Permanently', '301', '172.217.20.206']], 'fr2.node.check-host.net': [[0, 0.000416994094848633, 'Bad file descriptor', None, None]], 'hk1.node.check-host.net': [[1, 0.611221075057983, 'Moved Permanently', '301', '172.217.20.206']], 'ir1.node.check-host.net': [[1, 0.30132007598877, 'Moved Permanently', '301', '172.217.20.206']], 'it2.node.check-host.net': [[1, 0.0857341289520264, 'Moved Permanently', '301', '172.217.20.206']], 'kz1.node.check-host.net': [[1, 0.254606008529663, 'Moved Permanently', '301', '172.217.20.206']], 'lt1.node.check-host.net': [[1, 0.115381956100464, 'Moved Permanently', '301', '172.217.20.206']], 'md1.node.check-host.net': [[1, 0.14452600479126, 'Moved Permanently', '301', '172.217.20.206']], 'nl1.node.check-host.net': [[1, 0.084277868270874, 'Moved Permanently', '301', '172.217.20.206']], 'pt1.node.check-host.net': [[1, 0.145337104797363, 'Moved Permanently', '301', '172.217.20.206']], 'ru1.node.check-host.net': [[1, 0.0911569595336914, 'Moved Permanently', '301', '172.217.20.206']], 'ru2.node.check-host.net': [[1, 0.104975938796997, 'Moved Permanently', '301', '172.217.20.206']], 'tr1.node.check-host.net': [[1, 0.142112970352173, 'Moved Permanently', '301', '172.217.20.206']], 'ua1.node.check-host.net': [[1, 0.0839087963104248, 'Moved Permanently', '301', '172.217.20.206']], 'ua2.node.check-host.net': [[1, 0.0697171688079834, 'Moved Permanently', '301', '172.217.20.206']], 'us1.node.check-host.net': [[1, 0.367809057235718, 'Moved Permanently', '301', '172.217.20.206']], 'us2.node.check-host.net': [[1, 0.230828046798706, 'Moved Permanently', '301', '172.217.20.206']]},
     {'HOST_SUCCESS': 20, 'HOST_FAILED': 1}),
    ({'at1.node.check-host.net': [[['OK', 0.0316579341888428, '172.217.20.206'], ['OK', 0.0315918922424316], ['OK', 0.0318388938903809], ['OK', 0.0318410396575928]]], 'au1.node.check-host.net': [[['OK', 0.333691120147705, '172.217.20.206'], ['OK', 0.333482027053833], ['OK', 0.333156108856201], ['OK', 0.333092212677002]]], 'ca1.node.check-host.net': [[['OK', 0.105993032455444, '172.217.20.206'], ['OK', 0.105595111846924], ['OK', 0.105907917022705], ['OK', 0.113509893417358]]], 'ch1.node.check-host.net': [[['OK', 0.0278470516204834, '172.217.20.206'], ['OK', 0.0277290344238281], ['OK', 0.0277559757232666], ['OK', 0.0278029441833496]]], 'de4.node.check-host.net': [[['OK', 0.0151970386505127, '172.217.20.206'], ['OK', 0.0151298046112061], ['OK', 0.0152411460876465], ['OK', 0.0151441097259521]]], 'fr2.node.check-host.net': [[['OK', 0.0241789817810059, '172.217.20.206'], ['OK', 0.0242249965667725], ['OK', 0.02423095703125], ['OK', 0.0244019031524658]]], 'hk1.node.check-host.net': [[['OK', 0.282397031784058, '172.217.20.206'], ['OK', 0.282402038574219], ['OK', 0.28305196762085], ['OK', 0.282651901245117]]], 'ir1.node.check-host.net': [[['OK', 0.128709077835083, '172.217.20.206'], ['OK', 0.127197980880737], ['OK', 0.127739191055298], ['OK', 0.127892971038818]]], 'it2.node.check-host.net': [[['OK', 0.0231759548187256, '172.217.20.206'], ['OK', 0.0233228206634521], ['OK', 0.0234138965606689], ['OK', 0.0233712196350098]]], 'kz1.node.check-host.net': [[['OK', 0.102428913116455, '172.217.20.206'], ['OK', 0.101989984512329], ['OK', 0.101851940155029], ['OK', 0.101827144622803]]], 'lt1.node.check-host.net': [[['OK', 0.0377449989318848, '172.217.20.206'], ['OK', 0.0377700328826904], ['OK', 0.0377190113067627], ['OK', 0.0405981540679932]]], 'md1.node.check-host.net': [[['OK', 0.054236888885498, '172.217.20.206'], ['OK', 0.0539469718933105], ['OK', 0.0540990829467773], ['OK', 0.0539700984954834]]], 'nl1.node.check-host.net': [[['OK', 0.0215370655059814, '172.217.20.206'], ['OK', 0.0217139720916748], ['OK', 0.0214800834655762], ['OK', 0.0215709209442139]]], 'pt1.node.check-host.net': [[['OK', 0.0541989803314209, '172.217.20.206'], ['OK', 0.0539259910583496], ['OK', 0.05381178855896], ['OK', 0.0540590286254883]]], 'ru1.node.check-host.net': [[['OK', 0.0248539447784424, '172.217.20.206'], ['OK', 0.0249049663543701], ['OK', 0.0252151489257812], ['OK', 0.0248899459838867]]], 'ru2.node.check-host.net': [[['OK', 0.0309820175170898, '172.217.20.206'], ['OK', 0.0310549736022949], ['OK', 0.031080961227417], ['OK', 0.031207799911499]]], 'tr1.node.check-host.net': [[['OK', 0.0519599914550781, '172.217.20.206'], ['OK', 0.051645040512085], ['OK', 0.0515270233154297], ['OK', 0.0516729354858398]]], 'ua1.node.check-host.net': [[['OK', 0.0203659534454346, '172.217.20.206'], ['OK', 0.0204041004180908], ['OK', 0.0203869342803955], ['OK', 0.0204460620880127]]], 'ua2.node.check-host.net': [[['OK', 0.0151441097259521, '172.217.20.206'], ['OK', 0.015110969543457], ['OK', 0.0153429508209229], ['OK', 0.0149960517883301]]], 'us1.node.check-host.net': [[['OK', 0.16454005241394, '172.217.20.206'], ['OK', 0.164553165435791], ['OK', 0.164659023284912], ['OK', 0.164567947387695]]], 'us2.node.check-host.net': [[['OK', 0.095566987991333, '172.217.20.206'], ['OK', 0.0952150821685791], ['OK', 0.0951499938964844], ['OK', 0.09523606300354]]]},
     {'HOST_SUCCESS': 21}),
    ({'at1.node.check-host.net': [[['TIMEOUT', 3.00089383125305, '121.11.11.11'], ['TIMEOUT', 3.0002110004425], ['TIMEOUT', 3.00109696388245], ['TIMEOUT', 3.00079393386841]]], 'au1.node.check-host.net': [[['TIMEOUT', 3.00071597099304, '121.11.11.11'], ['TIMEOUT', 3.00035500526428], ['TIMEOUT', 3.00068497657776], ['TIMEOUT', 3.00024700164795]]], 'ca1.node.check-host.net': [[['TIMEOUT', 3.00092887878418, '121.11.11.11'], ['TIMEOUT', 3.00111103057861], ['TIMEOUT', 3.00084900856018], ['TIMEOUT', 3.00088286399841]]], 'ch1.node.check-host.net': [[['TIMEOUT', 3.00009608268738, '121.11.11.11'], ['TIMEOUT', 3.00066804885864], ['TIMEOUT', 3.00110983848572], ['TIMEOUT', 3.00113987922668]]], 'de4.node.check-host.net': [[['TIMEOUT', 3.00079488754272, '121.11.11.11'], ['TIMEOUT', 3.00083804130554], ['TIMEOUT', 3.00042700767517], ['TIMEOUT', 3.00089693069458]]], 'fr2.node.check-host.net': [[['TIMEOUT', 3.000648021698, '121.11.11.11'], ['TIMEOUT', 3.00107598304749], ['TIMEOUT', 3.00043892860413], ['TIMEOUT', 3.00037097930908]]], 'hk1.node.check-host.net': [[['TIMEOUT', 3.00099611282349, '121.11.11.11'], ['TIMEOUT', 3.00098705291748], ['TIMEOUT', 3.00036311149597], ['TIMEOUT', 3.00019216537476]]], 'ir1.node.check-host.net': [[['TIMEOUT', 3.00031590461731, '121.11.11.11'], ['TIMEOUT', 3.00022506713867], ['TIMEOUT', 3.00066900253296], ['TIMEOUT', 3.00071310997009]]], 'it2.node.check-host.net': [[['TIMEOUT', 3.00068807601929, '121.11.11.11'], ['TIMEOUT', 3.00028204917908], ['TIMEOUT', 3.00080800056458], ['TIMEOUT', 3.00089502334595]]], 'kz1.node.check-host.net': [[['TIMEOUT', 3.00043797492981, '121.11.11.11'], ['TIMEOUT', 3.00078892707825], ['TIMEOUT', 3.00067901611328], ['TIMEOUT', 3.00071811676025]]], 'lt1.node.check-host.net': [[['TIMEOUT', 3.0007529258728, '121.11.11.11'], ['TIMEOUT', 3.00017094612122], ['TIMEOUT', 3.00071787834167], ['TIMEOUT', 3.00072312355042]]], 'md1.node.check-host.net': [[['TIMEOUT', 3.00091791152954, '121.11.11.11'], ['TIMEOUT', 3.00043988227844], ['TIMEOUT', 3.000648021698], ['TIMEOUT', 3.00074315071106]]], 'nl1.node.check-host.net': [[['TIMEOUT', 3.00045108795166, '121.11.11.11'], ['TIMEOUT', 3.00016689300537], ['TIMEOUT', 3.00091505050659], ['TIMEOUT', 3.00097107887268]]], 'pt1.node.check-host.net': [[['TIMEOUT', 3.00065207481384, '121.11.11.11'], ['TIMEOUT', 3.00094890594482], ['TIMEOUT', 3.00088095664978], ['TIMEOUT', 3.00059604644775]]], 'ru1.node.check-host.net': [[['TIMEOUT', 3.00064301490784, '121.11.11.11'], ['TIMEOUT', 3.0005669593811], ['TIMEOUT', 3.00078105926514], ['TIMEOUT', 3.0002908706665]]], 'ru2.node.check-host.net': [[['TIMEOUT', 3.00062894821167, '121.11.11.11'], ['TIMEOUT', 3.00034403800964], ['TIMEOUT', 3.00063109397888], ['TIMEOUT', 3.00073099136353]]], 'tr1.node.check-host.net': [[['TIMEOUT', 3.00047206878662, '121.11.11.11'], ['TIMEOUT', 3.0012571811676], ['TIMEOUT', 3.00039505958557], ['TIMEOUT', 3.00044393539429]]], 'ua1.node.check-host.net': [[['TIMEOUT', 3.00061392784119, '121.11.11.11'], ['TIMEOUT', 3.00062799453735], ['TIMEOUT', 3.00012111663818], ['TIMEOUT', 3.00083208084106]]], 'ua2.node.check-host.net': [[['TIMEOUT', 3.0006411075592, '121.11.11.11'], ['TIMEOUT', 3.00106692314148], ['TIMEOUT', 3.00097894668579], ['TIMEOUT', 3.00027108192444]]], 'us1.node.check-host.net': [[['TIMEOUT', 3.00088810920715, '121.11.11.11'], ['TIMEOUT', 3.00015020370483], ['TIMEOUT', 3.00026512145996], ['TIMEOUT', 3.00017213821411]]], 'us2.node.check-host.net': [[['TIMEOUT', 3.00115299224854, '121.11.11.11'], ['TIMEOUT', 3.00075387954712], ['TIMEOUT', 3.00066208839417], ['TIMEOUT', 3.00096082687378]]]},
     {'HOST_FAILED': 21}),
    ({}, {}),
])
def test_count_host_statuses(distribution, statuses_counter):
    actual = count_host_statuses(distribution)
    assert len(actual) == len(statuses_counter)
    for (key, value) in statuses_counter.items():
        assert actual[key] == value


def test_fetch_host_statuses():
    _ctx = Context()
    _ctx.host = 'google.com'
    update_host_ip(_ctx)
    assert len(_ctx.host_ip) > 0
    distribution = fetch_host_statuses(_ctx)
    # some nodes have issues with file descriptor or connection
    assert distribution[HOST_SUCCESS_STATUS] > 17
